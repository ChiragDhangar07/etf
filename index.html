<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Portfolio Tracker - Live Prices</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2b 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
        }

        h1 {
            color: #1a1a2e;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .update-time {
            color: #1a1a2e;
            font-size: 0.9em;
        }

        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #1a1a2e;
            font-size: 1.8em;
            font-weight: bold;
        }

        .profit-positive {
            color: #27ae60;
        }

        .profit-negative {
            color: #e74c3c;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: #2c3e50;
            color: #e4e4e4;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #34495e;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2b 100%);
            color: #1a1a2e;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background: #0f3460;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #1a1a2e;
            border-radius: 10px;
            overflow: hidden;
        }

        th {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2b 100%);
            color: #1a1a2e;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #2c3e50;
        }

        tr:hover {
            background: #16213e;
        }

        input {
            background: #2c3e50;
            border: 2px solid #34495e;
            color: #e4e4e4;
            padding: 8px 12px;
            border-radius: 5px;
            width: 100%;
            font-size: 0.95em;
        }

        input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .live-price {
            background: #27ae60 !important;
            border-color: #27ae60 !important;
            color: white !important;
            font-weight: bold;
        }

        .total-row {
            background: #16213e;
            font-weight: bold;
            font-size: 1.1em;
        }

        .total-row td {
            border-top: 3px solid #d4af37;
            padding-top: 15px;
            padding-bottom: 15px;
        }

        .add-btn, .refresh-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            margin-right: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .add-btn:hover, .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: #1a1a2e;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #d4af37;
        }

        .dashboard-card h3 {
            color: #d4af37;
            margin-bottom: 15px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #2c3e50;
        }

        .alert {
            background: #f39c12;
            color: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .tabs {
                flex-direction: column;
            }

            table {
                font-size: 0.85em;
            }

            input {
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span class="update-time">Live Prices ‚Ä¢ Last Updated: <span id="lastUpdate">Loading...</span></span>
            </div>
            <h1>üí∞ Investment Portfolio Tracker</h1>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Investment</div>
                    <div class="stat-value" id="totalInvestment">‚Çπ0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Value</div>
                    <div class="stat-value" id="totalValue">‚Çπ0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Profit</div>
                    <div class="stat-value profit-positive" id="totalProfit">‚Çπ0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Overall Return</div>
                    <div class="stat-value profit-positive" id="totalReturn">0%</div>
                </div>
            </div>
            <button class="refresh-btn" onclick="fetchLivePrices()">üîÑ Refresh Live Prices</button>
        </header>

        <div id="priceAlert" class="alert" style="display:none;">
            <strong>‚ö†Ô∏è Note:</strong> Live prices fetched via API proxy. Click refresh to update.
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('silver')">Tata Silver</button>
            <button class="tab" onclick="showTab('silverbees')">Silver Bees</button>
            <button class="tab" onclick="showTab('gold')">Tata Gold</button>
            <button class="tab" onclick="showTab('goldbees')">Gold Bees</button>
            <button class="tab" onclick="showTab('dashboard')">Dashboard</button>
        </div>

        <div id="silver" class="tab-content active">
            <h2>ü•à Tata Silver Holdings</h2>
            <table id="silverTable">
                <thead>
                    <tr>
                        <th>Fund</th>
                        <th>Quantity</th>
                        <th>Avg Price (‚Çπ)</th>
                        <th>Investment (‚Çπ)</th>
                        <th>Current Price (‚Çπ)</th>
                        <th>Current Value (‚Çπ)</th>
                        <th>Profit (‚Çπ)</th>
                        <th>Profit %</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="silverBody"></tbody>
            </table>
            <button class="add-btn" onclick="addRow('silver')">+ Add Position</button>
        </div>

        <div id="silverbees" class="tab-content">
            <h2>ü•à Silver Bees ETF</h2>
            <table id="silverbeesTable">
                <thead>
                    <tr>
                        <th>Fund</th>
                        <th>Quantity</th>
                        <th>Avg Price (‚Çπ)</th>
                        <th>Investment (‚Çπ)</th>
                        <th>Current Price (‚Çπ)</th>
                        <th>Current Value (‚Çπ)</th>
                        <th>Profit (‚Çπ)</th>
                        <th>Profit %</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="silverbeesBody"></tbody>
            </table>
            <button class="add-btn" onclick="addRow('silverbees')">+ Add Position</button>
        </div>

        <div id="gold" class="tab-content">
            <h2>ü•á Tata Gold Holdings</h2>
            <table id="goldTable">
                <thead>
                    <tr>
                        <th>Fund</th>
                        <th>Quantity</th>
                        <th>Avg Price (‚Çπ)</th>
                        <th>Investment (‚Çπ)</th>
                        <th>Current Price (‚Çπ)</th>
                        <th>Current Value (‚Çπ)</th>
                        <th>Profit (‚Çπ)</th>
                        <th>Profit %</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="goldBody"></tbody>
            </table>
            <button class="add-btn" onclick="addRow('gold')">+ Add Position</button>
        </div>

        <div id="goldbees" class="tab-content">
            <h2>ü•á Gold Bees ETF</h2>
            <table id="goldbeesTable">
                <thead>
                    <tr>
                        <th>Fund</th>
                        <th>Quantity</th>
                        <th>Avg Price (‚Çπ)</th>
                        <th>Investment (‚Çπ)</th>
                        <th>Current Price (‚Çπ)</th>
                        <th>Current Value (‚Çπ)</th>
                        <th>Profit (‚Çπ)</th>
                        <th>Profit %</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="goldbeesBody"></tbody>
            </table>
            <button class="add-btn" onclick="addRow('goldbees')">+ Add Position</button>
        </div>

        <div id="dashboard" class="tab-content">
            <h2>üìä Portfolio Dashboard</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Asset Allocation</h3>
                    <div id="allocation"></div>
                </div>
                <div class="dashboard-card">
                    <h3>Top Performers</h3>
                    <div id="topPerformers"></div>
                </div>
                <div class="dashboard-card">
                    <h3>Category Totals</h3>
                    <div id="categoryTotals"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const portfolioData = {
            silver: [
                {name: 'YC', qty: 86827, avgPrice: 22.59, currentPrice: 33.95, symbol: 'TATSILV.NS'},
                {name: 'QF', qty: 72450, avgPrice: 27.59, currentPrice: 33.95, symbol: 'TATSILV.NS'},
                {name: 'FQ', qty: 48953, avgPrice: 18.59, currentPrice: 33.95, symbol: 'TATSILV.NS'},
                {name: 'VX', qty: 21200, avgPrice: 25.38, currentPrice: 33.95, symbol: 'TATSILV.NS'},
                {name: 'SL', qty: 96607, avgPrice: 22.46, currentPrice: 33.95, symbol: 'TATSILV.NS'}
            ],
            silverbees: [
                {name: 'Silver Bees', qty: 10000, avgPrice: 185, currentPrice: 311.54, symbol: 'SILVERBEES.NS'}
            ],
            gold: [
                {name: 'Tata Gold', qty: 66340, avgPrice: 13.25, currentPrice: 16.1, symbol: 'TGOLD.NS'}
            ],
            goldbees: [
                {name: 'Gold Bees', qty: 10000, avgPrice: 105.71, currentPrice: 135.55, symbol: 'GOLDBEES.NS'}
            ]
        };

        // Fetch live prices using Yahoo Finance API via CORS proxy
        async function fetchLivePrices() {
            const btn = event?.target;
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Fetching Live Prices...';
            }

            document.getElementById('priceAlert').style.display = 'block';

            try {
                // Collect unique symbols
                const symbols = new Set();
                Object.values(portfolioData).flat().forEach(item => symbols.add(item.symbol));

                // Fetch prices for each symbol
                const pricePromises = Array.from(symbols).map(async symbol => {
                    try {
                        // Using Yahoo Finance via CORS Anywhere alternative
                        const corsProxy = 'https://api.allorigins.win/raw?url=';
                        const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;

                        const response = await fetch(corsProxy + encodeURIComponent(yahooUrl));
                        const data = await response.json();

                        if (data.chart && data.chart.result && data.chart.result[0]) {
                            const price = data.chart.result[0].meta.regularMarketPrice;
                            return { symbol, price };
                        }
                        return { symbol, price: null };
                    } catch (error) {
                        console.error(`Error fetching ${symbol}:`, error);
                        return { symbol, price: null };
                    }
                });

                const results = await Promise.all(pricePromises);

                // Create price map
                const priceMap = {};
                results.forEach(({ symbol, price }) => {
                    if (price) priceMap[symbol] = price;
                });

                // Update prices in portfolio data
                let updateCount = 0;
                Object.keys(portfolioData).forEach(category => {
                    portfolioData[category].forEach(item => {
                        if (priceMap[item.symbol]) {
                            item.currentPrice = priceMap[item.symbol];
                            updateCount++;
                        }
                    });
                });

                // Re-render all tables
                Object.keys(portfolioData).forEach(category => {
                    renderTable(category);
                });

                // Update timestamp
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('en-IN');

                if (updateCount > 0) {
                    alert(`‚úÖ Successfully updated ${updateCount} live prices!`);
                } else {
                    alert('‚ö†Ô∏è Could not fetch live prices. Using cached values. Try again or check console for errors.');
                }

            } catch (error) {
                console.error('Error fetching live prices:', error);
                alert('‚ùå Failed to fetch live prices. Check console for details.');
            }

            if (btn) {
                btn.disabled = false;
                btn.textContent = 'üîÑ Refresh Live Prices';
            }
        }

        function formatCurrency(num) {
            return '‚Çπ' + num.toLocaleString('en-IN', {maximumFractionDigits: 2});
        }

        function calculate(qty, avgPrice, currentPrice) {
            const investment = qty * avgPrice;
            const currentValue = qty * currentPrice;
            const profit = currentValue - investment;
            const profitPct = (profit / investment) * 100;
            return {investment, currentValue, profit, profitPct};
        }

        function renderTable(category) {
            const tbody = document.getElementById(category + 'Body');
            tbody.innerHTML = '';

            let totalQty = 0, totalInv = 0, totalValue = 0;

            portfolioData[category].forEach((item, index) => {
                const calc = calculate(item.qty, item.avgPrice, item.currentPrice);
                totalQty += item.qty;
                totalInv += calc.investment;
                totalValue += calc.currentValue;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${item.name}" onchange="updateData('${category}', ${index}, 'name', this.value)"></td>
                    <td><input type="number" value="${item.qty}" onchange="updateData('${category}', ${index}, 'qty', parseFloat(this.value))"></td>
                    <td><input type="number" step="0.01" value="${item.avgPrice.toFixed(2)}" onchange="updateData('${category}', ${index}, 'avgPrice', parseFloat(this.value))"></td>
                    <td>${formatCurrency(calc.investment)}</td>
                    <td><input type="number" step="0.01" value="${item.currentPrice.toFixed(2)}" class="live-price" readonly title="Live price from market"></td>
                    <td>${formatCurrency(calc.currentValue)}</td>
                    <td class="${calc.profit >= 0 ? 'profit-positive' : 'profit-negative'}">${formatCurrency(calc.profit)}</td>
                    <td class="${calc.profitPct >= 0 ? 'profit-positive' : 'profit-negative'}">${calc.profitPct.toFixed(2)}%</td>
                    <td><button class="delete-btn" onclick="deleteRow('${category}', ${index})">Delete</button></td>
                `;
            });

            const totalProfit = totalValue - totalInv;
            const totalProfitPct = (totalProfit / totalInv) * 100;

            const totalRow = tbody.insertRow();
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td><strong>${totalQty.toLocaleString()}</strong></td>
                <td>-</td>
                <td><strong>${formatCurrency(totalInv)}</strong></td>
                <td>-</td>
                <td><strong>${formatCurrency(totalValue)}</strong></td>
                <td class="${totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}"><strong>${formatCurrency(totalProfit)}</strong></td>
                <td class="${totalProfitPct >= 0 ? 'profit-positive' : 'profit-negative'}"><strong>${totalProfitPct.toFixed(2)}%</strong></td>
                <td>-</td>
            `;

            updateHeader();
            updateDashboard();
        }

        function updateData(category, index, field, value) {
            portfolioData[category][index][field] = value;
            renderTable(category);
        }

        function addRow(category) {
            const defaultSymbol = category === 'silver' ? 'TATSILV.NS' : 
                                 category === 'silverbees' ? 'SILVERBEES.NS' :
                                 category === 'gold' ? 'TGOLD.NS' : 'GOLDBEES.NS';
            portfolioData[category].push({
                name: 'New Position',
                qty: 0,
                avgPrice: 0,
                currentPrice: 0,
                symbol: defaultSymbol
            });
            renderTable(category);
        }

        function deleteRow(category, index) {
            if (confirm('Are you sure you want to delete this position?')) {
                portfolioData[category].splice(index, 1);
                renderTable(category);
            }
        }

        function updateHeader() {
            let totalInv = 0, totalValue = 0;

            Object.keys(portfolioData).forEach(category => {
                portfolioData[category].forEach(item => {
                    const calc = calculate(item.qty, item.avgPrice, item.currentPrice);
                    totalInv += calc.investment;
                    totalValue += calc.currentValue;
                });
            });

            const totalProfit = totalValue - totalInv;
            const totalReturn = (totalProfit / totalInv) * 100;

            document.getElementById('totalInvestment').textContent = formatCurrency(totalInv);
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('totalReturn').textContent = totalReturn.toFixed(2) + '%';

            document.getElementById('totalProfit').className = totalProfit >= 0 ? 'stat-value profit-positive' : 'stat-value profit-negative';
            document.getElementById('totalReturn').className = totalReturn >= 0 ? 'stat-value profit-positive' : 'stat-value profit-negative';
        }

        function updateDashboard() {
            const categoryStats = {};
            const allPositions = [];

            Object.keys(portfolioData).forEach(category => {
                let catInv = 0, catValue = 0;

                portfolioData[category].forEach(item => {
                    const calc = calculate(item.qty, item.avgPrice, item.currentPrice);
                    catInv += calc.investment;
                    catValue += calc.currentValue;

                    allPositions.push({
                        category,
                        name: item.name,
                        profitPct: calc.profitPct,
                        profit: calc.profit
                    });
                });

                categoryStats[category] = {
                    investment: catInv,
                    value: catValue,
                    profit: catValue - catInv,
                    profitPct: ((catValue - catInv) / catInv) * 100
                };
            });

            let categoryHTML = '';
            Object.keys(categoryStats).forEach(cat => {
                const stats = categoryStats[cat];
                categoryHTML += `
                    <div class="metric-row">
                        <span><strong>${cat.toUpperCase()}</strong></span>
                        <span class="${stats.profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                            <strong>${formatCurrency(stats.profit)} (${stats.profitPct.toFixed(2)}%)</strong>
                        </span>
                    </div>
                `;
            });
            document.getElementById('categoryTotals').innerHTML = categoryHTML;

            allPositions.sort((a, b) => b.profitPct - a.profitPct);
            let performersHTML = '';
            allPositions.slice(0, 5).forEach((pos, i) => {
                performersHTML += `
                    <div class="metric-row">
                        <span>${i + 1}. ${pos.name}</span>
                        <span class="profit-positive"><strong>${pos.profitPct.toFixed(2)}%</strong></span>
                    </div>
                `;
            });
            document.getElementById('topPerformers').innerHTML = performersHTML;

            const totalValue = Object.values(categoryStats).reduce((sum, cat) => sum + cat.value, 0);
            let allocationHTML = '';
            Object.keys(categoryStats).forEach(cat => {
                const pct = (categoryStats[cat].value / totalValue) * 100;
                allocationHTML += `
                    <div class="metric-row">
                        <span>${cat.toUpperCase()}</span>
                        <span><strong>${pct.toFixed(2)}%</strong></span>
                    </div>
                `;
            });
            document.getElementById('allocation').innerHTML = allocationHTML;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Initialize
        Object.keys(portfolioData).forEach(category => {
            renderTable(category);
        });

        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('en-IN');

        // Auto-fetch on load after 2 seconds
        setTimeout(() => {
            console.log('Auto-fetching live prices...');
            fetchLivePrices();
        }, 2000);

        // Auto-refresh every 5 minutes during market hours
        setInterval(() => {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const isMarketHours = (hours === 9 && minutes >= 15) || (hours > 9 && hours < 15) || (hours === 15 && minutes <= 30);

            if (isMarketHours) {
                console.log('Auto-refreshing prices (market hours)...');
                fetchLivePrices();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
